<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>TS-DAR Tutorial for Alanine Dipeptide &#8212; TS-DAR Example Gallery 1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=61cd365c" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=12dfc556" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css?v=2aa19091" />
    <script src="../../_static/documentation_options.js?v=29a6c3e3"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="prev" title="Example Notebook Gallery" href="../../examples.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="TS-DAR-Tutorial-for-Alanine-Dipeptide">
<h1>TS-DAR Tutorial for Alanine Dipeptide<a class="headerlink" href="#TS-DAR-Tutorial-for-Alanine-Dipeptide" title="Link to this heading">¶</a></h1>
<p><strong>Reference</strong>: Liu, B., Boysen, J.G., Unarta, I.C. et al. Exploring transition states of protein conformational changes via out-of-distribution detection in the hyperspherical latent space. Nat Commun 16, 349 (2025). <a class="reference external" href="https://doi.org/10.1038/s41467-024-55228-4">https://doi.org/10.1038/s41467-024-55228-4</a></p>
<section id="TS-DAR-Framework:-An-Overview">
<h2>TS-DAR Framework: An Overview<a class="headerlink" href="#TS-DAR-Framework:-An-Overview" title="Link to this heading">¶</a></h2>
<p>In this notebook, we introduce <strong>Transition State identification via Dispersion and vAriational principle Regularized neural networks (TS-DAR)</strong>, a computational framework that utilizes out-of-distribution (OOD) detection to accurately and simultaneously identify transition states involved in specific biomolecular conformational changes. TS-DAR leverages a deep learning model to map protein conformations from molecular dynamics (MD) simulations into a hyperspherical latent space. This
low-dimensional representation preserves the essential kinetic information while still capturing the protein’s dynamic behavior. To distinguish metastable states from transition states, TS-DAR employs a VAMP-2 loss and dispersion loss function:</p>
<ol class="arabic simple">
<li><p><strong>VAMP-2 Loss:</strong> Encourages the latent representation to capture the slow dynamics of the system by maximizing correlations between time-lagged data.</p></li>
<li><p><strong>Dispersion Loss:</strong> Ensures that the latent space does not collapse by promoting a well-dispersed representation of the macrostates.</p></li>
</ol>
<section id="VAMP-2-Loss">
<h3>VAMP-2 Loss<a class="headerlink" href="#VAMP-2-Loss" title="Link to this heading">¶</a></h3>
<p>The VAMP-2 loss is derived from the Variational Approach for Markov Processes, which aims to extract the slow collective variables from the data. Given an MD trajectory of length <span class="math notranslate nohighlight">\(T\)</span>, a batch of transition pairs <span class="math notranslate nohighlight">\(\{(x_t, x_{t+\tau})\}_{t=1}^b\)</span> with lag time, <span class="math notranslate nohighlight">\(\tau\)</span>, is sampled. This produces two batches of data: <span class="math notranslate nohighlight">\(\mathbf{B} = [x_1, x_2, \dots, x_b]^T\)</span> and <span class="math notranslate nohighlight">\(\mathbf{\hat{B}} = [x_{1+\tau}, x_{2+\tau}, \dots, x_{b+\tau}]^T\)</span>, which are fed into two parallel network
lobes with shared parameters. Each lobe outputs SoftMax-transformed basis functions (<span class="math notranslate nohighlight">\(\chi\)</span>) applied to the input features, yielding: <span class="math notranslate nohighlight">\(\mathbf{X} = [\chi(x_1), \dots, \chi(x_b)]^T\)</span> and <span class="math notranslate nohighlight">\(\mathbf{Y} = [\chi(x_{1+\tau}), \dots, \chi(x_{b+\tau})]^T\)</span>. The remove-mean time-instantaneous (<span class="math notranslate nohighlight">\(\bar{\mathbf{C}}_{00}\)</span> and <span class="math notranslate nohighlight">\(\bar{\mathbf{C}}_{11}\)</span>) and time-lagged (<span class="math notranslate nohighlight">\(\bar{\mathbf{C}}_{01}\)</span>) correlation matrices can then be calculated as follows:</p>
<div class="math notranslate nohighlight">
\[\bar{\mathbf{C}}_{00} = \frac{1}{T - \tau} \mathbf{X}^T \mathbf{X} - \boldsymbol{\pi}_0 \boldsymbol{\pi}_0^T\]</div>
<div class="math notranslate nohighlight">
\[\bar{\mathbf{C}}_{11} = \frac{1}{T - \tau} \mathbf{Y}^T \mathbf{Y} - \boldsymbol{\pi}_1 \boldsymbol{\pi}_1^T\]</div>
<div class="math notranslate nohighlight">
\[\bar{\mathbf{C}}_{01} = \frac{1}{T - \tau} \mathbf{X}^T \mathbf{Y} - \boldsymbol{\pi}_0 \boldsymbol{\pi}_1^T\]</div>
<p>where <span class="math notranslate nohighlight">\(\boldsymbol{\pi}_0\)</span> and <span class="math notranslate nohighlight">\(\boldsymbol{\pi}_1\)</span> are mean vectors of <span class="math notranslate nohighlight">\(\mathbf{X}\)</span> and <span class="math notranslate nohighlight">\(\mathbf{Y}\)</span>, respectively, given by: <span class="math notranslate nohighlight">\(\boldsymbol{\pi}_0\)</span> = <span class="math notranslate nohighlight">\(\frac{1}{T - \tau} \mathbf{X}^T \mathbf{1}\)</span> and <span class="math notranslate nohighlight">\(\boldsymbol{\pi}_1\)</span> = <span class="math notranslate nohighlight">\(\frac{1}{T - \tau} \mathbf{Y}^T \mathbf{1}\)</span>. These correlation matrices are then used to calculate the VAMP-2 loss, which is defined as:</p>
<div class="math notranslate nohighlight">
\[\mathcal{L}_{\text{vamp2}} = - \left\| \bar{\mathbf{C}}_{00}^{-\frac{1}{2}} \bar{\mathbf{C}}_{01} \bar{\mathbf{C}}_{11}^{-\frac{1}{2}} \right\|_{\mathcal{F}}^2 - 1\]</div>
<p>Minimizing this loss drives the model to learn latent features that capture the slow dynamical modes in the molecular system.</p>
</section>
<section id="Dispersion-Loss">
<h3>Dispersion Loss<a class="headerlink" href="#Dispersion-Loss" title="Link to this heading">¶</a></h3>
<p>While the VAMP-2 loss focuses on capturing the slow dynamics, it can sometimes result in a latent space where the features collapse to similar values. To counteract this, TS-DAR incorporates a <strong>dispersion loss</strong> that encourages diversity in the latent space. One way to formulate the dispersion loss is by ensuring that the pairwise distances between latent representations are close to a target mean distance. The dispersion loss is defined as:</p>
<div class="math notranslate nohighlight">
\[\mathcal{L}_{dis} = \frac{1}{C} \sum_{i=1}^{C} \log \frac{1}{C-1} \sum_{j=1}^{C} \mathbf{1}_{\{j \neq i\}} e^{\frac{\mu_i^T \mu_j}{\sigma}}\]</div>
<p>where:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(C\)</span> corresponds to the number of states.</p></li>
<li><p><span class="math notranslate nohighlight">\(\mu_i\)</span> is a unit vector representing the mean direction of all conformations (i.e., the state center) in state <span class="math notranslate nohighlight">\(i\)</span>.</p></li>
<li><p><span class="math notranslate nohighlight">\(\sigma\)</span> is a scaling hyperparameter, which is specifically defined as 0.1.</p></li>
<li><p><span class="math notranslate nohighlight">\(\mathbf{1}_{\{j \neq i\}}\)</span> is an indicator function that equals 1 when <span class="math notranslate nohighlight">\(j \neq i\)</span> (i.e., excluding self-similarity) and 0 when <span class="math notranslate nohighlight">\(j = i\)</span>.</p></li>
</ul>
<p>This loss penalizes deviations from the target dispersion, ensuring that the latent features remain well-separated and informative.</p>
</section>
<section id="Combined-Loss-Function">
<h3>Combined Loss Function<a class="headerlink" href="#Combined-Loss-Function" title="Link to this heading">¶</a></h3>
<p>The overall training objective of the TS-DAR framework is a weighted combination of the VAMP-2 loss and the dispersion loss:</p>
<div class="math notranslate nohighlight">
\[\mathcal{L}_{\text{total}} = \mathcal{L}_{\text{VAMP-2}} + β\mathcal{L}_{\text{disp}}\]</div>
<p>Here, (<code class="docutils literal notranslate"><span class="pre">β</span></code>) is a hyperparameter that balances the contribution of the dispersion term relative to the VAMP-2 loss.</p>
</section>
<section id="Summary">
<h3>Summary<a class="headerlink" href="#Summary" title="Link to this heading">¶</a></h3>
<p>The TS-DAR framework leverages: (1) <strong>VAMP-2 Loss</strong> to extract the slow, metastable dynamics inherent in molecular systems, and (2) <strong>Dispersion Loss</strong> to maintain a well-structured, diverse latent space. This approach contains an end-to-end pipeline that enhances the detection of transition states, providing deeper insights into molecular conformational changes. In the sections that follow, we will demonstrate the implementation of these loss functions and apply the TS-DAR framework to analyze
alanine dipeptide MD data.</p>
</section>
</section>
<section id="Before-starting,-make-sure-you-have-done-the-following:">
<h2>Before starting, make sure you have done the following:<a class="headerlink" href="#Before-starting,-make-sure-you-have-done-the-following:" title="Link to this heading">¶</a></h2>
<p>wget <a class="reference external" href="https://repo.anaconda.com/archive/Anaconda3-2024.06-1-Linux-x86_64.sh">https://repo.anaconda.com/archive/Anaconda3-2024.06-1-Linux-x86_64.sh</a> ./Anaconda3-2024.06-1-Linux-x86_64.sh #### 2. Create a new conda environment and install the ts-dar source code locally: conda create -n ts-dar python=3.9 conda activate ts-dar #### 3. Install dependencies !pip install matplotlib numpy==1.26.1 scipy==1.11.4 torch==1.13.1 tqdm==4.66.1 #### 4. Clone the repository !git clone <a class="reference external" href="https://github.com/xuhuihuang/ts-dar.git">https://github.com/xuhuihuang/ts-dar.git</a> #### 5. Install the package !python -m pip install ./ts-dar</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[154]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">from</span> <span class="nn">torch.utils.data.dataloader</span> <span class="kn">import</span> <span class="n">DataLoader</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">random_split</span>

<span class="kn">from</span> <span class="nn">tsdar.utils</span> <span class="kn">import</span> <span class="n">set_random_seed</span>
<span class="kn">from</span> <span class="nn">tsdar.loss</span> <span class="kn">import</span> <span class="n">Prototypes</span>
<span class="kn">from</span> <span class="nn">tsdar.model</span> <span class="kn">import</span> <span class="n">TSDAR</span><span class="p">,</span> <span class="n">TSDARLayer</span><span class="p">,</span> <span class="n">TSDAREstimator</span>
<span class="kn">from</span> <span class="nn">tsdar.dataprocessing</span> <span class="kn">import</span> <span class="n">Preprocessing</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[156]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cuda is available&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
cpu
</pre></div></div>
</div>
</section>
<section id="Contour-Plot-of-2D-Probability-Densities:">
<h2>Contour Plot of 2D Probability Densities:<a class="headerlink" href="#Contour-Plot-of-2D-Probability-Densities:" title="Link to this heading">¶</a></h2>
<p>This notebook implements a <code class="docutils literal notranslate"><span class="pre">ContourPlot2D</span></code> class for visualizing the free energy landscape using the <strong>bivariate kernel density estimation (KDE)</strong>.</p>
<section id="Features:">
<h3>Features:<a class="headerlink" href="#Features:" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p><strong>KDE Estimation</strong>: Uses <code class="docutils literal notranslate"><span class="pre">scipy.stats.gaussian_kde</span></code> to compute probability densities.</p></li>
<li><p><strong>Thermodynamic Transformation</strong>: Converts KDE values using a logarithmic transformation.</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[158]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ContourPlot2D</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bw_method</span><span class="o">=</span><span class="s1">&#39;scotts&#39;</span><span class="p">,</span> <span class="n">num_grids</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">temperature</span><span class="o">=</span><span class="mf">310.</span><span class="p">,</span> <span class="n">shade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">n_levels</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_bw_method</span> <span class="o">=</span> <span class="n">bw_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_grids</span> <span class="o">=</span> <span class="n">num_grids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cut</span> <span class="o">=</span> <span class="n">cut</span>
        <span class="k">if</span> <span class="n">clip</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_clip</span> <span class="o">=</span> <span class="p">[(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_temperature</span> <span class="o">=</span> <span class="n">temperature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shade</span> <span class="o">=</span> <span class="n">shade</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alpha</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vmin</span> <span class="o">=</span> <span class="n">vmin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vmax</span> <span class="o">=</span> <span class="n">vmax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_levels</span> <span class="o">=</span> <span class="n">n_levels</span>

    <span class="k">def</span> <span class="nf">_kde_support</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">bw</span><span class="p">,</span> <span class="n">num_grids</span><span class="p">,</span> <span class="n">cut</span><span class="p">,</span> <span class="n">clip</span><span class="p">):</span>

        <span class="n">support_min</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">bw</span> <span class="o">*</span> <span class="n">cut</span><span class="p">,</span> <span class="n">clip</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">support_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">bw</span> <span class="o">*</span> <span class="n">cut</span><span class="p">,</span> <span class="n">clip</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">support_min</span><span class="p">,</span> <span class="n">support_max</span><span class="p">,</span> <span class="n">num_grids</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_scipy_bivariate_kde</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">bw_method</span><span class="p">,</span> <span class="n">num_grids</span><span class="p">,</span> <span class="n">cut</span><span class="p">,</span> <span class="n">clip</span><span class="p">):</span>

        <span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
        <span class="n">kde</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">gaussian_kde</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">six</span> <span class="kn">import</span> <span class="n">string_types</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bw_method</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
            <span class="n">bw_x</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">kde</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_factor&quot;</span> <span class="o">%</span> <span class="n">bw_method</span><span class="p">)()</span> <span class="o">*</span> <span class="n">std</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">bw_y</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">kde</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_factor&quot;</span> <span class="o">%</span> <span class="n">bw_method</span><span class="p">)()</span> <span class="o">*</span> <span class="n">std</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Please input the string of a valid bandwidth method.&#39;</span><span class="p">)</span>

        <span class="n">x_support</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kde_support</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">bw_x</span><span class="p">,</span> <span class="n">num_grids</span><span class="p">,</span> <span class="n">cut</span><span class="p">,</span> <span class="n">clip</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">y_support</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kde_support</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">bw_y</span><span class="p">,</span> <span class="n">num_grids</span><span class="p">,</span> <span class="n">cut</span><span class="p">,</span> <span class="n">clip</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_support</span><span class="p">,</span> <span class="n">y_support</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">kde</span><span class="p">([</span><span class="n">xx</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">yy</span><span class="o">.</span><span class="n">ravel</span><span class="p">()])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">z</span>

    <span class="k">def</span> <span class="nf">_thermo_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">temperature</span><span class="p">):</span>

        <span class="kn">import</span> <span class="nn">scipy</span>
        <span class="kn">from</span> <span class="nn">scipy.constants</span> <span class="kn">import</span> <span class="n">Avogadro</span><span class="p">,</span> <span class="n">Boltzmann</span><span class="p">,</span> <span class="n">calorie_th</span>
        <span class="n">THERMO_CONSTANT</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">3</span> <span class="o">*</span> <span class="n">Boltzmann</span> <span class="o">*</span> <span class="n">Avogadro</span> <span class="o">/</span> <span class="n">calorie_th</span>

        <span class="c1">#return - THERMO_CONSTANT * temperature * np.log(z)</span>
        <span class="k">return</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cbar_kwargs</span><span class="o">=</span><span class="p">{},</span>
            <span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>

        <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scipy_bivariate_kde</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bw_method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_grids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cut</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clip</span><span class="p">)</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thermo_transform</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_temperature</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vmin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vmin</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1E-12</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shade</span><span class="p">:</span>
            <span class="n">cf</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span> <span class="o">-</span> <span class="n">Z</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_levels</span><span class="p">),</span>
                             <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_alpha</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_vmax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;rainbow&#39;</span><span class="p">)</span>

        <span class="n">cs</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span> <span class="o">-</span> <span class="n">Z</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
                        <span class="c1">#cmap=plt.get_cmap(&#39;bone_r&#39;),</span>
                        <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                        <span class="n">linewidths</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_levels</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                        <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_vmax</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cbar</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shade</span><span class="p">:</span>
                <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cf</span><span class="p">,</span> <span class="o">**</span><span class="n">cbar_kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="o">**</span><span class="n">cbar_kwargs</span><span class="p">)</span>

            <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
            <span class="c1">#cbar.set_label(&#39;Free energy (kcal/mol)&#39;, fontsize=labelsize)</span>

        <span class="c1">#ax.grid(zorder=0)</span>

        <span class="k">if</span> <span class="n">xlabel</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">labelsize</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ylabel</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">labelsize</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ax</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span> <span class="o">-</span> <span class="n">Z</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="Download-and-Load-Alanine-Dipeptide-Simulation-Data:">
<h2>Download and Load Alanine Dipeptide Simulation Data:<a class="headerlink" href="#Download-and-Load-Alanine-Dipeptide-Simulation-Data:" title="Link to this heading">¶</a></h2>
<p>This section loads molecular dynamics (MD) simulation data for alanine dipeptide. We have:</p>
<ul class="simple">
<li><p><strong>Atomic coordinates (``xyz_traj``)</strong>: 3D positions of atoms from the simulation.</p></li>
<li><p><strong>Dihedral angles (``dihedral_traj``)</strong>: Backbone torsion angles (ϕ, ψ) that define molecular conformation.</p></li>
</ul>
<p>Each dataset contains <strong>three independent trajectories</strong>.</p>
<p>Please download the dataset from the link below, and place it under the base directory, unzip the file:</p>
<p><a class="reference external" href="https://zenodo.org/records/16922765/files/Alanine_dipeptide.zip?download=1">https://zenodo.org/records/16922765/files/Alanine_dipeptide.zip?download=1</a></p>
<p>Change the directrory to “./Alanine_dipeptide/”.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[159]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialize lists to store trajectory data</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">dihedral</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Define base directory path (modify as needed)</span>
<span class="n">base_dir</span> <span class="o">=</span> <span class="s1">&#39;./Alanine_dipeptide_data/&#39;</span>

<span class="c1"># Load 3D atomic coordinates (trajectories)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">data_file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">base_dir</span><span class="si">}</span><span class="s1">xyz_traj</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">.npy&#39;</span>  <span class="c1"># Construct file path</span>
    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">data_file_path</span><span class="p">))</span>  <span class="c1"># Load and append trajectory</span>

<span class="c1"># Load dihedral angles (Backbone torsion angles)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">d_file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">base_dir</span><span class="si">}</span><span class="s1">dihedral_traj</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">.npy&#39;</span>  <span class="c1"># Construct file path</span>
    <span class="n">dihedral</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">d_file_path</span><span class="p">))</span>  <span class="c1"># Load and append trajectory</span>

<span class="c1"># Print dataset shapes to confirm loading</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2"> XYZ trajectories with shapes: </span><span class="si">{</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">shape</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">data</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dihedral</span><span class="p">)</span><span class="si">}</span><span class="s2"> dihedral trajectories with shapes: </span><span class="si">{</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">shape</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">dihedral</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Loaded 3 XYZ trajectories with shapes: [(250000, 30), (250000, 30), (250000, 30)]
Loaded 3 dihedral trajectories with shapes: [(250000, 2), (250000, 2), (250000, 2)]
</pre></div></div>
</div>
</section>
<section id="Data-Interpretation:">
<h2>Data Interpretation:<a class="headerlink" href="#Data-Interpretation:" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p><strong>XYZ Trajectories</strong>:</p>
<ul>
<li><p><strong>Shape</strong>: <code class="docutils literal notranslate"><span class="pre">(250000,</span> <span class="pre">30)</span></code></p></li>
<li><p><strong>Meaning</strong>: 250K simulation frames, storing the <strong>xyz positions of 10 atoms</strong>.</p></li>
</ul>
</li>
<li><p><strong>Dihedral Trajectories</strong>:</p>
<ul>
<li><p><strong>Shape</strong>: <code class="docutils literal notranslate"><span class="pre">(250000,</span> <span class="pre">2)</span></code></p></li>
<li><p><strong>Meaning</strong>: 250K frames, each containing <strong>two backbone torsion angles (ϕ, ψ)</strong>.</p></li>
</ul>
</li>
</ul>
</section>
<section id="Next-Steps:">
<h2>Next Steps:<a class="headerlink" href="#Next-Steps:" title="Link to this heading">¶</a></h2>
<section id="Projecting-the-Free-Energy-Landscape:">
<h3>Projecting the Free Energy Landscape:<a class="headerlink" href="#Projecting-the-Free-Energy-Landscape:" title="Link to this heading">¶</a></h3>
<p>We will now <strong>compute and visualize the free energy landscape</strong> of alanine dipeptide by projecting it onto the two backbone torsion angles, <strong>ϕ (phi) and ψ (psi)</strong>.</p>
</section>
<section id="Key-Features:">
<h3>Key Features:<a class="headerlink" href="#Key-Features:" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p><strong>Contour Plot</strong>: Uses kernel density estimation to compute free energy.</p></li>
<li><p><strong>Color Mapping</strong>: Indicates stable and unstable molecular conformations.</p></li>
<li><p><strong>Axes</strong>:</p>
<ul>
<li><p><strong>X-axis (ϕ angle)</strong> → Ranges from <code class="docutils literal notranslate"><span class="pre">-180°</span></code> to <code class="docutils literal notranslate"><span class="pre">180°</span></code></p></li>
<li><p><strong>Y-axis (ψ angle)</strong> → Ranges from <code class="docutils literal notranslate"><span class="pre">-180°</span></code> to <code class="docutils literal notranslate"><span class="pre">180°</span></code></p></li>
</ul>
</li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[160]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a figure and axis for the plot</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="c1"># Customize axis borders (thicker for better visibility)</span>
<span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">]:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># Set aspect ratio to 1 (square plot)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Initialize the ContourPlot2D class and plot free energy landscape</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">ContourPlot2D</span><span class="p">(</span><span class="n">shade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">n_levels</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">dihedral</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Set axis limits to cover the full range of torsion angles (-π to π)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

<span class="c1"># Convert tick labels from radians to degrees for better readability</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">],</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">180</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">],</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">180</span><span class="p">])</span>

<span class="c1"># Set a background color</span>
<span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span>  <span class="c1"># Dark blue shade</span>
<span class="n">ax</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">))</span>  <span class="c1"># Semi-transparent background</span>

<span class="c1"># Customize tick labels: increase font size and adjust tick properties</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mf">17.5</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mf">7.5</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>

<span class="c1"># Set axis labels with phi (ϕ) and psi (ψ) symbols</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\phi$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\psi$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="n">cbar_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">cbar_ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Free Energy / kT&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mf">17.5</span><span class="p">)</span>
<span class="n">cbar_ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">])</span>  <span class="c1"># Adjust the list to your desired ticks</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[160]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&lt;matplotlib.axis.YTick at 0x3195be8b0&gt;,
 &lt;matplotlib.axis.YTick at 0x319837490&gt;,
 &lt;matplotlib.axis.YTick at 0x32322b550&gt;,
 &lt;matplotlib.axis.YTick at 0x32549dfa0&gt;,
 &lt;matplotlib.axis.YTick at 0x319837820&gt;,
 &lt;matplotlib.axis.YTick at 0x31823e670&gt;,
 &lt;matplotlib.axis.YTick at 0x32333bc40&gt;]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_alanine_dipeptide_Alanine_dipeptide_9_1.png" src="../../_images/examples_alanine_dipeptide_Alanine_dipeptide_9_1.png" />
</div>
</div>
</section>
</section>
<section id="Preprocessing-Molecular-Dynamics-Data:">
<h2>Preprocessing Molecular Dynamics Data:<a class="headerlink" href="#Preprocessing-Molecular-Dynamics-Data:" title="Link to this heading">¶</a></h2>
<p>Preprocess the original trajectories to create datasets for training.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[161]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pre</span> <span class="o">=</span> <span class="n">Preprocessing</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">pre</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">lag_time</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span> <span class="c1">#The lag_time used to create the dataset consisting of time-instant and time-lagged data</span>
</pre></div>
</div>
</div>
</section>
<section id="Training-the-TS-DAR-Model:">
<h2>Training the TS-DAR Model:<a class="headerlink" href="#Training-the-TS-DAR-Model:" title="Link to this heading">¶</a></h2>
<p>We now train a TS-DAR Model to learn a <strong>latent space representation of the protein structures</strong>. This consists of <strong>(a) feature extraction</strong>: protein structures are transformed into a suitable representation (e.g., coordinates, distances, or angles between atoms); <strong>(b) encoder training</strong>: The encoder learns to compress the input conformations (high-dimensional protein structures) into a lower-dimensional latent space.</p>
<section id="Key-Steps:">
<h3>Key Steps:<a class="headerlink" href="#Key-Steps:" title="Link to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p><strong>Data Splitting</strong>: 90% training data &amp; 10% validation data (for model evaluation)</p></li>
<li><p><strong>Batch Loading</strong>:</p>
<ul class="simple">
<li><p>Training batch size = <code class="docutils literal notranslate"><span class="pre">1000</span></code> (shuffled)</p></li>
<li><p>Validation batch = <code class="docutils literal notranslate"><span class="pre">entire</span> <span class="pre">validation</span> <span class="pre">set</span></code> (not shuffled)</p></li>
</ul>
</li>
<li><p><strong>TS-DAR Model Setup</strong>:</p>
<ul class="simple">
<li><p><strong>Latent space</strong>: (<code class="docutils literal notranslate"><span class="pre">d-1</span></code>)-dimensional hypersphere</p></li>
<li><p><strong>n_states</strong>: number of metastable states</p></li>
<li><p><strong>Learning rate</strong>: <code class="docutils literal notranslate"><span class="pre">1e-3</span></code></p></li>
<li><p><strong>Weight of dispersion loss (``β``)</strong>: <code class="docutils literal notranslate"><span class="pre">0.01</span></code> (has been optimized - this can stay at 0.01 for most systems). The determination of the magnitude of β is guided by the following two criteria: (1) The dispersion loss can converge to the minimum boundary; (2) There is no significant deviation in VAMP-2 loss before and after integrating the dispersion loss optimization.</p></li>
</ul>
</li>
<li><p><strong>Training the Model</strong>: Pretrain for 10 epochs, then train for another 10 epochs</p></li>
</ol>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[162]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Ensure reproducibility by setting a fixed random seed</span>
<span class="n">set_random_seed</span><span class="p">(</span><span class="mi">33</span><span class="p">)</span>

<span class="c1"># Split dataset: 90% training, 10% validation</span>
<span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="o">*</span><span class="mf">0.10</span><span class="p">)</span>
<span class="n">train_data</span><span class="p">,</span> <span class="n">val_data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">random_split</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="o">-</span><span class="n">val</span><span class="p">,</span> <span class="n">val</span><span class="p">])</span> <span class="c1"># randomly split the data</span>

<span class="n">loader_train</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># load data in batches and shuffle data</span>
<span class="n">loader_val</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">val_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">val_data</span><span class="p">),</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Initialize the TS-DAR model with specific network architecture</span>
<span class="n">lobe</span> <span class="o">=</span> <span class="n">TSDARLayer</span><span class="p">([</span><span class="mi">30</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="n">n_states</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># Move model to appropriate device (CPU/GPU)</span>
<span class="n">lobe</span> <span class="o">=</span> <span class="n">lobe</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># Initialize TS-DAR model for training</span>
<span class="n">tsdar</span> <span class="o">=</span> <span class="n">TSDAR</span><span class="p">(</span><span class="n">lobe</span> <span class="o">=</span> <span class="n">lobe</span><span class="p">,</span> <span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="n">device</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;regularize&#39;</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">feat_dim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_states</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">pretrain</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">tsdar_model</span> <span class="o">=</span> <span class="n">tsdar</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">loader_train</span><span class="p">,</span> <span class="n">n_epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">validation_loader</span><span class="o">=</span><span class="n">loader_val</span><span class="p">)</span><span class="o">.</span><span class="n">fetch_model</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
</section>
</section>
<section id="TS-DAR-Model-Validation-Curve:">
<h2>TS-DAR Model Validation Curve:<a class="headerlink" href="#TS-DAR-Model-Validation-Curve:" title="Link to this heading">¶</a></h2>
<p>To evaluate the TS-DAR model, we plot the <strong>VAMP-2 loss</strong> over training epochs. You should train the model until this plot converges. During training, the model adjusts its parameters to minizmize the loss function. Convergence means that the model’s loss function is optimized, indicating that it has effectively learned patterns from the data. If stopped before convergence, the model might fail to learn the meaningful patterns.</p>
<div class="line-block">
<div class="line"><strong>Training too little</strong> → Model is underfit, leading to high error on both training &amp; validation sets.</div>
<div class="line"><strong>Training too much</strong> → Model overfits, meaning it memorizes the training data but performs poorly on new data.</div>
</div>
<section id="What-is-VAMP-2-Loss?">
<h3>What is VAMP-2 Loss?<a class="headerlink" href="#What-is-VAMP-2-Loss?" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p><strong>VAMP-2 (Variational Approach for Markov Processes)</strong> measures how well the model captures slow dynamical processes.</p></li>
</ul>
<div class="math notranslate nohighlight">
\[\mathcal{L}_{\text{vamp2}} = - \left\| \bar{\mathbf{C}}_{00}^{-\frac{1}{2}} \bar{\mathbf{C}}_{01} \bar{\mathbf{C}}_{11}^{-\frac{1}{2}} \right\|_{\mathcal{F}}^2 - 1 \tag{2}\]</div>
<p>### Interpretation:</p>
<ul class="simple">
<li><p><strong>Higher VAMP-2 score</strong> (i.e., <strong>lower loss</strong>) → better approximation of <strong>kinetic variance</strong>, meaning:</p>
<ul>
<li><p>Improved separation of <strong>metastable states</strong></p></li>
<li><p>Latent space captures <strong>meaningful dynamical structure</strong></p></li>
</ul>
</li>
<li><p><strong>Plateauing loss</strong> → indicates <strong>training convergence</strong></p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[163]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Create a figure with a specific size</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="c1"># Define custom colors for the line and markers</span>
<span class="n">line_color</span> <span class="o">=</span> <span class="s1">&#39;royalblue&#39;</span>
<span class="n">marker_face</span> <span class="o">=</span> <span class="s1">&#39;white&#39;</span>
<span class="n">marker_edge</span> <span class="o">=</span> <span class="s1">&#39;royalblue&#39;</span>

<span class="c1"># Plot with custom colors, line width, and markers</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tsdar</span><span class="o">.</span><span class="n">validation_vamp</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">line_color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
         <span class="n">markersize</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">markerfacecolor</span><span class="o">=</span><span class="n">marker_face</span><span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="n">marker_edge</span><span class="p">)</span>

<span class="c1"># Set the axis labels</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Training Epochs&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;VAMP-2 Loss&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">2.25</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">2.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># Customize tick parameters for readability</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mf">17.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mf">17.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_box_aspect</span><span class="p">(</span><span class="mf">0.85</span><span class="p">)</span>

<span class="c1"># Add a dashed grid to improve the readability of the plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>

<span class="c1"># Adjust the layout to ensure everything fits well</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="c1"># Display the plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_alanine_dipeptide_Alanine_dipeptide_15_0.png" src="../../_images/examples_alanine_dipeptide_Alanine_dipeptide_15_0.png" />
</div>
</div>
</section>
</section>
<section id="What-is-Dispersion-Loss?">
<h2>What is Dispersion Loss?<a class="headerlink" href="#What-is-Dispersion-Loss?" title="Link to this heading">¶</a></h2>
<p>While the VAMP-2 loss enhances intrastate compactness, it can result in a latent space where different metastable states are unevenly distributed. To address this, TS-DAR incorporates a dispersion loss that regularizes the hyperspherical latent space, ensuring the metastable state centers (or free energy minima) are uniformly distributed across the hypersphere. As a result, all transition state conformations, located between free energy basins, can be simultaneously and automatically identified
based on their cosine similarities to the state centers. The dispersion loss is defined as:</p>
<div class="math notranslate nohighlight">
\[\mathcal{L}_{dis} = \frac{1}{C} \sum_{i=1}^{C} \log \frac{1}{C-1} \sum_{j=1}^{C} \mathbf{1}_{\{j \neq i\}} e^{\frac{\mu_i^T \mu_j}{\sigma}}\]</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[164]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Create a figure with a specific size for publication</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="c1"># Define custom colors for the line and markers</span>
<span class="n">line_color</span> <span class="o">=</span> <span class="s1">&#39;royalblue&#39;</span>
<span class="n">marker_face</span> <span class="o">=</span> <span class="s1">&#39;white&#39;</span>
<span class="n">marker_edge</span> <span class="o">=</span> <span class="s1">&#39;royalblue&#39;</span>

<span class="c1"># Plot with custom colors, line width, and markers</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tsdar</span><span class="o">.</span><span class="n">validation_dis</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">line_color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
         <span class="n">markersize</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">markerfacecolor</span><span class="o">=</span><span class="n">marker_face</span><span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="n">marker_edge</span><span class="p">)</span>

<span class="c1"># Set the axis labels</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Training Epochs&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Dispersion Loss&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="c1">#plt.ylim(0, 2.25)</span>
<span class="c1">#plt.yticks(np.arange(0, 2.1, 0.5))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># Customize tick parameters for readability</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mf">17.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mf">17.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_box_aspect</span><span class="p">(</span><span class="mf">0.85</span><span class="p">)</span>

<span class="c1"># Add a dashed grid to improve the readability of the plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>

<span class="c1"># Adjust the layout to ensure everything fits well</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="c1"># Display the plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_alanine_dipeptide_Alanine_dipeptide_17_0.png" src="../../_images/examples_alanine_dipeptide_Alanine_dipeptide_17_0.png" />
</div>
</div>
</section>
<section id="Estimate-Metastable-State-Center-Vectors-&amp;-Compute-Out-of-Distribution-(OOD)-Scores:">
<h2>Estimate Metastable State Center Vectors &amp; Compute Out-of-Distribution (OOD) Scores:<a class="headerlink" href="#Estimate-Metastable-State-Center-Vectors-&-Compute-Out-of-Distribution-(OOD)-Scores:" title="Link to this heading">¶</a></h2>
<p>After training the <strong>TS-DAR model</strong>, we now:</p>
<ol class="arabic simple">
<li><p><strong>Estimate metastable state center vectors</strong> on the hypersphere.</p></li>
<li><p><strong>Compute OOD scores</strong> → Identifies rare conformations.</p></li>
<li><p><strong>Extract hyperspherical embeddings</strong> → Low-dimensional representation of data.</p></li>
<li><p><strong>Compute OOD threshold</strong> for detecting <strong>transition state (TS).</strong> structures.</p></li>
</ol>
<section id="Key-Concepts:">
<h3>Key Concepts:<a class="headerlink" href="#Key-Concepts:" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p><strong>State Center Vectors</strong>:</p>
<ul>
<li><p>Represent metastable states in the learned hyperspherical latent space.</p></li>
<li><p>Are optimized via dispersion loss to be evenly spread out (maximally separated).</p></li>
</ul>
</li>
<li><p><strong>OOD Scores</strong>:</p>
<ul>
<li><p>Measure of how “rare” a molecular conformation is relative to known metastable states.</p></li>
</ul>
</li>
<li><p><strong>OOD Threshold (``thres``)</strong>: Helps detect transition states.</p>
<ul>
<li><p>Two approaches:</p>
<ul>
<li><p><strong>Theoretical</strong> → Based on angular distances between state centers.</p></li>
<li><p><strong>Empirical</strong> → Based on the maximum OOD score in the dataset.</p></li>
<li><p><strong>Use the approach that gives you a smaller value</strong></p></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[165]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialize the TS-DAR Estimator to compute metastable state centers</span>
<span class="n">tsdar_estimator</span> <span class="o">=</span> <span class="n">TSDAREstimator</span><span class="p">(</span><span class="n">tsdar_model</span><span class="p">)</span>

<span class="c1"># Compute the Out-of-Distribution (OOD) scores</span>
<span class="n">ood_scores</span> <span class="o">=</span> <span class="n">tsdar_estimator</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">ood_scores</span>

<span class="c1"># Extract the hyperspherical embeddings (transformed feature representation)</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">tsdar_model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">return_type</span><span class="o">=</span><span class="s1">&#39;hypersphere_embs&#39;</span><span class="p">)</span>

<span class="c1"># Compute the state center vectors for metastable states on the hypersphere</span>
<span class="n">state_centers</span> <span class="o">=</span> <span class="n">tsdar_estimator</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">state_centers</span>

<span class="c1"># Compute the pairwise anglular distances between metastable state centers</span>
<span class="n">sim_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">state_centers</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">state_centers</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
<span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">sim_mat</span><span class="p">,</span><span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

<span class="c1"># OOD Threshold Computation:</span>

<span class="c1"># Theoretical threshold (based on the angle between state centers)</span>
<span class="c1"># thres = -np.cos(sim_mat.min()/2)+1</span>

<span class="c1"># Empirical threshold (based on the maximum OOD score)</span>
<span class="n">thres</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">ood_scores</span><span class="p">))</span>

<span class="c1"># NOTE: use the smaller value for thres</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/var/folders/9g/tn_8xgqj79527t9txzwlnh9c0000gn/T/ipykernel_73911/807288760.py:14: RuntimeWarning: invalid value encountered in arccos
  sim_mat = np.arccos(state_centers.dot(state_centers.T))
</pre></div></div>
</div>
</section>
</section>
<section id="Free-Energy-Landscape-Colored-by-OOD-Score:">
<h2>Free Energy Landscape Colored by OOD Score:<a class="headerlink" href="#Free-Energy-Landscape-Colored-by-OOD-Score:" title="Link to this heading">¶</a></h2>
<p>This plot projects the <strong>free energy landscape</strong> of alanine dipeptide onto the two backbone torsion angles, <strong>ϕ (phi) and ψ (psi)</strong>. The dots represent sampled molecular conformations.</p>
<ul class="simple">
<li><p><strong>Color mapping</strong>:</p>
<ul>
<li><p><strong>Low OOD scores</strong> (blue) → Metastable state conformations.</p></li>
<li><p><strong>High OOD scores</strong> (red) → Rare or transition state conformations.</p></li>
</ul>
</li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[166]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Create figure and axis</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="c1"># Customize axis</span>
<span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">]:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># Ensure equal aspect ratio (important for angles)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>

<span class="c1"># Concatenate dihedral angles and OOD scores for easier handling</span>
<span class="n">all_dihedral</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">dihedral</span><span class="p">)</span>
<span class="n">all_ood</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">ood_scores</span><span class="p">)</span>

<span class="c1"># Main scatter plot (background) – small points colored by OOD scores</span>
<span class="n">cb</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_dihedral</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">all_dihedral</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">c</span><span class="o">=</span><span class="n">all_ood</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Set colorbar range (thres is the OOD score cutoff)</span>
<span class="n">cb</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">thres</span><span class="p">)</span>

<span class="c1"># Add a colorbar with formatted ticks</span>
<span class="n">ccc</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span>
<span class="n">ccc</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">ccc</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;OOD score&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

<span class="c1"># Set axis limits (full range of dihedral angles)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

<span class="c1"># Set axis labels with phi (ϕ) and psi (ψ) symbols</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\phi$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\psi$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="c1"># Convert tick labels from radians to degrees</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">180</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">180</span><span class="p">])</span>

<span class="c1"># Add contour lines for free energy landscape</span>
<span class="n">cs</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span>
                <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                <span class="n">linewidths</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
                <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="c1"># Customize tick labels and styling</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mf">17.5</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mf">7.5</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>

<span class="c1"># Set a background color for the axis</span>
<span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span>
<span class="n">ax</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">))</span>


<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_alanine_dipeptide_Alanine_dipeptide_21_0.png" src="../../_images/examples_alanine_dipeptide_Alanine_dipeptide_21_0.png" />
</div>
</div>
</section>
<section id="Visualization-of-Hyperspherical-Embeddings-and-Metastable-State-Centers:">
<h2>Visualization of Hyperspherical Embeddings and Metastable State Centers:<a class="headerlink" href="#Visualization-of-Hyperspherical-Embeddings-and-Metastable-State-Centers:" title="Link to this heading">¶</a></h2>
<p>This plot shows the <strong>hyperspherical embeddings</strong> (<code class="docutils literal notranslate"><span class="pre">features</span></code>) learned by the TS-DAR model, along with the <strong>metastable state centers</strong> (<code class="docutils literal notranslate"><span class="pre">state_centers</span></code>). Each dot represents a molecular conformation in the learned feature space.</p>
<section id="id1">
<h3>Key Features:<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p><strong>Color Mapping</strong>: OOD scores differentiate between rare and metastable state conformations.</p>
<ul>
<li><p><strong>Low OOD scores</strong> (blue) → Metastable state conformations.</p></li>
<li><p><strong>High OOD scores</strong> (red) → Rare or transition state conformations.</p></li>
</ul>
</li>
<li><p><strong>Dashed Black Line</strong>: Shows <strong>metastable state centers</strong>.</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[167]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">,</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="s1">&#39;right&#39;</span><span class="p">]:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>

<span class="n">cb</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">features</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">features</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">c</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">ood_scores</span><span class="p">),</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">cb</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="n">thres</span><span class="p">)</span>

<span class="n">ccc</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span>
<span class="n">ccc</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">ccc</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;OOD score&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">state_centers</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],[</span><span class="mi">0</span><span class="p">,</span><span class="n">state_centers</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">state_centers</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],[</span><span class="mi">0</span><span class="p">,</span><span class="n">state_centers</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.1</span><span class="p">,</span><span class="mf">1.1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.1</span><span class="p">,</span><span class="mf">1.1</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

<span class="c1"># Set axis labels with phi (ϕ) and psi (ψ) symbols</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$z_1$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$z_2$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span><span class="n">labelsize</span><span class="o">=</span><span class="mf">17.5</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="s1">&#39;out&#39;</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="mf">7.5</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>

<span class="n">r</span><span class="o">=</span><span class="mf">0.1</span>
<span class="n">g</span><span class="o">=</span><span class="mf">0.1</span>
<span class="n">b</span><span class="o">=</span><span class="mf">0.2</span>
<span class="n">ax</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="mf">.15</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_alanine_dipeptide_Alanine_dipeptide_23_0.png" src="../../_images/examples_alanine_dipeptide_Alanine_dipeptide_23_0.png" />
</div>
</div>
</section>
</section>
<section id="Example:-Training-TS-DAR-with-3-and-4-States">
<h2>Example: Training TS-DAR with 3 and 4 States<a class="headerlink" href="#Example:-Training-TS-DAR-with-3-and-4-States" title="Link to this heading">¶</a></h2>
<p>In the following section, we repeat the <strong>same training procedure</strong> but modify the number of <strong>metastable states</strong>. We provide <strong>example training runs</strong> for the <strong>3-state and 4-state models</strong> to illustrate how the TS-DAR framework can be adapted for different metastable state counts.</p>
<section id="Important-Note:">
<h3>Important Note:<a class="headerlink" href="#Important-Note:" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>The number of metastable states for your system should <strong>not</strong> be chosen arbitrarily. The correct approach is to <strong>build a microstate Markov State Model (MSM)</strong> and analyze the <strong>Implied Timescales (ITS) plot</strong>. The ITS plot shows the dominant relaxation timescales as a function of lag time, helping to confirm that the dynamics are Markovian and that the model is robust. The optimal number of metastable states can then be determined based on the system’s kinetics.</p></li>
<li><p>For more detail, see: Wu, Y.; Cao, S.; Qiu, Y.; Huang, X. The Journal of Chemical Physics 2024, 160 (12). DOI: 10.1063/5.0189429</p></li>
</ul>
</section>
</section>
<section id="3-State-Model:">
<h2>3-State Model:<a class="headerlink" href="#3-State-Model:" title="Link to this heading">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[168]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">set_random_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="o">*</span><span class="mf">0.10</span><span class="p">)</span>
<span class="n">train_data</span><span class="p">,</span> <span class="n">val_data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">random_split</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="o">-</span><span class="n">val</span><span class="p">,</span> <span class="n">val</span><span class="p">])</span> <span class="c1"># the way the dataset is split depends on the underlying pseudo-random number generator</span>

<span class="n">loader_train</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">loader_val</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">val_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">val_data</span><span class="p">),</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">lobe</span> <span class="o">=</span> <span class="n">TSDARLayer</span><span class="p">([</span><span class="mi">30</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="n">n_states</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">lobe</span> <span class="o">=</span> <span class="n">lobe</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="n">tsdar</span> <span class="o">=</span> <span class="n">TSDAR</span><span class="p">(</span><span class="n">lobe</span> <span class="o">=</span> <span class="n">lobe</span><span class="p">,</span> <span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="n">device</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;regularize&#39;</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.01</span> <span class="p">,</span> <span class="n">feat_dim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_states</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">pretrain</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">tsdar_model</span> <span class="o">=</span> <span class="n">tsdar</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">loader_train</span><span class="p">,</span> <span class="n">n_epochs</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">validation_loader</span><span class="o">=</span><span class="n">loader_val</span><span class="p">)</span><span class="o">.</span><span class="n">fetch_model</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[173]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialize the TS-DAR Estimator to compute metastable state centers</span>
<span class="n">tsdar_estimator</span> <span class="o">=</span> <span class="n">TSDAREstimator</span><span class="p">(</span><span class="n">tsdar_model</span><span class="p">)</span>
<span class="c1"># Compute Out-of-Distribution (OOD) scores</span>
<span class="n">ood_scores</span> <span class="o">=</span> <span class="n">tsdar_estimator</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">ood_scores</span>
<span class="c1"># Extract the hyperspherical embeddings (transformed feature representation)</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">tsdar_model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">return_type</span><span class="o">=</span><span class="s1">&#39;hypersphere_embs&#39;</span><span class="p">)</span>
<span class="c1"># Compute the state center vectors for metastable states on the hypersphere</span>
<span class="n">state_centers</span> <span class="o">=</span> <span class="n">tsdar_estimator</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">state_centers</span>
<span class="c1"># Compute pairwise anglular distances between metastable state centers</span>
<span class="n">sim_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">state_centers</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">state_centers</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
<span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">sim_mat</span><span class="p">,</span><span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
<span class="c1"># Theoretical threshold (based on minimum angle between state centers)</span>
<span class="c1">#thres = -np.cos(sim_mat.min()/2)+1</span>
<span class="n">thres</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">ood_scores</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/var/folders/9g/tn_8xgqj79527t9txzwlnh9c0000gn/T/ipykernel_73911/1772777546.py:10: RuntimeWarning: invalid value encountered in arccos
  sim_mat = np.arccos(state_centers.dot(state_centers.T))
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[174]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TS-DAR model with 3 states successfully identified transition states (points with large OOD scores, shown in red)</span>

<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">,</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="s1">&#39;right&#39;</span><span class="p">]:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>

<span class="n">cb</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">dihedral</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">dihedral</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">c</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">ood_scores</span><span class="p">),</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">cb</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="n">thres</span><span class="p">)</span>

<span class="n">ccc</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span>
<span class="n">ccc</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">ccc</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;OOD score&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">],[</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">180</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">],[</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">180</span><span class="p">])</span>

<span class="c1"># Set axis labels with phi (ϕ) and psi (ψ) symbols</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\phi$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\psi$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="n">cs</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span>
            <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
            <span class="n">linewidths</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
            <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span><span class="n">labelsize</span><span class="o">=</span><span class="mf">17.5</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="s1">&#39;out&#39;</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="mf">7.5</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>

<span class="n">r</span><span class="o">=</span><span class="mf">0.1</span>
<span class="n">g</span><span class="o">=</span><span class="mf">0.1</span>
<span class="n">b</span><span class="o">=</span><span class="mf">0.2</span>
<span class="n">ax</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="mf">.15</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_alanine_dipeptide_Alanine_dipeptide_27_0.png" src="../../_images/examples_alanine_dipeptide_Alanine_dipeptide_27_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[175]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Hyperspherical latent representations with OOD scores obtained from TS-DAR are shown. Dashed lines point to the centers of metastable states</span>

<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">,</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="s1">&#39;right&#39;</span><span class="p">]:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>

<span class="n">cb</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">features</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">features</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">c</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">ood_scores</span><span class="p">),</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">cb</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="n">thres</span><span class="p">)</span>

<span class="n">ccc</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span>
<span class="n">ccc</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">ccc</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;OOD score&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">state_centers</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],[</span><span class="mi">0</span><span class="p">,</span><span class="n">state_centers</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">state_centers</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],[</span><span class="mi">0</span><span class="p">,</span><span class="n">state_centers</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">state_centers</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]],[</span><span class="mi">0</span><span class="p">,</span><span class="n">state_centers</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.1</span><span class="p">,</span><span class="mf">1.1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.1</span><span class="p">,</span><span class="mf">1.1</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span><span class="n">labelsize</span><span class="o">=</span><span class="mf">17.5</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="s1">&#39;out&#39;</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="mf">7.5</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>

<span class="n">r</span><span class="o">=</span><span class="mf">0.1</span>
<span class="n">g</span><span class="o">=</span><span class="mf">0.1</span>
<span class="n">b</span><span class="o">=</span><span class="mf">0.2</span>
<span class="n">ax</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="mf">.15</span><span class="p">))</span>

<span class="c1"># Set axis labels with phi (ϕ) and psi (ψ) symbols</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$z_1$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$z_2$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[175]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0, 0.5, &#39;$z_2$&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_alanine_dipeptide_Alanine_dipeptide_28_1.png" src="../../_images/examples_alanine_dipeptide_Alanine_dipeptide_28_1.png" />
</div>
</div>
</section>
<section id="4-State-Model:">
<h2>4-State Model:<a class="headerlink" href="#4-State-Model:" title="Link to this heading">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[176]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">set_random_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="o">*</span><span class="mf">0.10</span><span class="p">)</span>
<span class="n">train_data</span><span class="p">,</span> <span class="n">val_data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">random_split</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="o">-</span><span class="n">val</span><span class="p">,</span> <span class="n">val</span><span class="p">])</span>

<span class="n">loader_train</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">loader_val</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">val_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">val_data</span><span class="p">),</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">lobe</span> <span class="o">=</span> <span class="n">TSDARLayer</span><span class="p">([</span><span class="mi">30</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span><span class="n">n_states</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">lobe</span> <span class="o">=</span> <span class="n">lobe</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="n">tsdar</span> <span class="o">=</span> <span class="n">TSDAR</span><span class="p">(</span><span class="n">lobe</span> <span class="o">=</span> <span class="n">lobe</span><span class="p">,</span> <span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="n">device</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;regularize&#39;</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">feat_dim</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_states</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">pretrain</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">tsdar_model</span> <span class="o">=</span> <span class="n">tsdar</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">loader_train</span><span class="p">,</span> <span class="n">n_epochs</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">validation_loader</span><span class="o">=</span><span class="n">loader_val</span><span class="p">)</span><span class="o">.</span><span class="n">fetch_model</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[177]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialize the TS-DAR Estimator to compute metastable state centers</span>
<span class="n">tsdar_estimator</span> <span class="o">=</span> <span class="n">TSDAREstimator</span><span class="p">(</span><span class="n">tsdar_model</span><span class="p">)</span>
<span class="c1"># Compute Out-of-Distribution (OOD) scores</span>
<span class="n">ood_scores</span> <span class="o">=</span> <span class="n">tsdar_estimator</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">ood_scores</span>
<span class="c1"># Extract the hyperspherical embeddings (transformed feature representation)</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">tsdar_model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">return_type</span><span class="o">=</span><span class="s1">&#39;hypersphere_embs&#39;</span><span class="p">)</span>
<span class="c1"># Compute the state center vectors for metastable states on the hypersphere</span>
<span class="n">state_centers</span> <span class="o">=</span> <span class="n">tsdar_estimator</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">state_centers</span>
<span class="c1"># Compute pairwise anglular distances between metastable state centers</span>
<span class="n">sim_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">state_centers</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">state_centers</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
<span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">sim_mat</span><span class="p">,</span><span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
<span class="c1"># Theoretical threshold (based on minimum angle between state centers)</span>
<span class="c1">#thres = -np.cos(sim_mat.min()/2)+1</span>
<span class="n">thres</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">ood_scores</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/var/folders/9g/tn_8xgqj79527t9txzwlnh9c0000gn/T/ipykernel_73911/1772777546.py:10: RuntimeWarning: invalid value encountered in arccos
  sim_mat = np.arccos(state_centers.dot(state_centers.T))
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[178]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">,</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="s1">&#39;right&#39;</span><span class="p">]:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>

<span class="n">cb</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">dihedral</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">dihedral</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">c</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">ood_scores</span><span class="p">),</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">cb</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="n">thres</span><span class="p">)</span>

<span class="n">ccc</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span>
<span class="n">ccc</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">ccc</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;OOD score&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

<span class="c1"># Set axis labels with phi (ϕ) and psi (ψ) symbols</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\phi$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\psi$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">],[</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">180</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">],[</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">180</span><span class="p">])</span>

<span class="n">cs</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span>
            <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
            <span class="n">linewidths</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
            <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span><span class="n">labelsize</span><span class="o">=</span><span class="mf">17.5</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="s1">&#39;out&#39;</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="mf">7.5</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>

<span class="n">r</span><span class="o">=</span><span class="mf">0.1</span>
<span class="n">g</span><span class="o">=</span><span class="mf">0.1</span>
<span class="n">b</span><span class="o">=</span><span class="mf">0.2</span>
<span class="n">ax</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="mf">.15</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_alanine_dipeptide_Alanine_dipeptide_32_0.png" src="../../_images/examples_alanine_dipeptide_Alanine_dipeptide_32_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[179]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">r</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">pi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
<span class="n">cos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span>
<span class="n">sin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span>
<span class="n">phi</span><span class="p">,</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="mf">0.0</span><span class="p">:</span><span class="n">pi</span><span class="p">:</span><span class="mi">100</span><span class="n">j</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">:</span><span class="mf">2.0</span><span class="o">*</span><span class="n">pi</span><span class="p">:</span><span class="mi">100</span><span class="n">j</span><span class="p">]</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span>
   <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span>  <span class="n">rstride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">cstride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">antialiased</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">state_centers</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],[</span><span class="mi">0</span><span class="p">,</span><span class="n">state_centers</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],[</span><span class="mi">0</span><span class="p">,</span><span class="n">state_centers</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">state_centers</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],[</span><span class="mi">0</span><span class="p">,</span><span class="n">state_centers</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]],[</span><span class="mi">0</span><span class="p">,</span><span class="n">state_centers</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">state_centers</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]],[</span><span class="mi">0</span><span class="p">,</span><span class="n">state_centers</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]],[</span><span class="mi">0</span><span class="p">,</span><span class="n">state_centers</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">state_centers</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">]],[</span><span class="mi">0</span><span class="p">,</span><span class="n">state_centers</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">]],[</span><span class="mi">0</span><span class="p">,</span><span class="n">state_centers</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">]],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>

<span class="n">cb</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">features</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">features</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">features</span><span class="p">)[:,</span><span class="mi">2</span><span class="p">],</span><span class="n">c</span><span class="o">=</span><span class="n">ood_scores</span><span class="p">[:],</span><span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">)</span>
<span class="n">cb</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="n">thres</span><span class="p">)</span>

<span class="n">ccc</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span>
<span class="n">ccc</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">ccc</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;OOD score&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_zlim</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_zticks</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="s1">&#39;out&#39;</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="mf">7.5</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;z1&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;z2&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;z3&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="n">elev</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">azim</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_alanine_dipeptide_Alanine_dipeptide_33_0.png" src="../../_images/examples_alanine_dipeptide_Alanine_dipeptide_33_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">TS-DAR Example Gallery</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">TS-DAR Overview</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../examples.html">Example Notebook Gallery</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../examples.html#plotting-ts-dar">Plotting TS-DAR</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../examples.html#alanine-dipeptide">Alanine Dipeptide</a></li>
</ul>
</li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../../examples.html">Example Notebook Gallery</a><ul>
      <li>Previous: <a href="../../examples.html" title="previous chapter">Example Notebook Gallery</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, Michael O'Connor.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.3.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
      |
      <a href="../../_sources/examples/alanine_dipeptide/Alanine_dipeptide.ipynb.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>